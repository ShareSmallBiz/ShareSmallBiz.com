@using ShareSmallBiz.Portal.Controllers
@model PostModel

@{
    ViewData["Title"] = "Post Details";
    var currentUserName = User.Identity.IsAuthenticated ? User.Identity.Name : "";
}

<div class="container my-4">
    <!-- Post Content -->
    <div class="card mb-4">
        <div class="card-body">
            <h1 class="card-title">@Model.Title</h1>
            <div>
                @Html.Raw(Model.Content)
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div id="commentsContainer" class="card">
        <div class="card-header">
            <i class="bi bi-chat-right-text"></i> Comments
        </div>
        <div class="card-body">
            <div id="commentsList" class="list-group">
                @Html.Partial("_CommentsPartial", Model.Comments)
            </div>

            @if (User.Identity.IsAuthenticated)
            {
                <div id="addCommentSection" class="mt-3">
                    <div class="mb-3">
                        <textarea id="newCommentText" class="form-control" rows="3" placeholder="Add a comment"></textarea>
                    </div>
                    <button id="addCommentButton" data-post-id="@Model.Id" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Add Comment
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var currentUserName = '@currentUserName';

            // Handler for adding a comment
            $("#addCommentButton").click(function () {
                var postId = $(this).data("post-id");
                var commentText = $("#newCommentText").val();
                $.ajax({
                    url: '/post/' + postId + '/comment',
                    method: 'POST',
                    data: { comment: commentText },
                    success: function (response) {
                        // Replace the inner HTML of the commentsList div with the rendered partial view HTML
                        $("#commentsList").html(response);
                        $("#newCommentText").val('');
                    },
                    error: function () {
                        alert("Error adding comment.");
                    }
                });
            });

            // Delegate click event for deleting a comment
            $("#commentsContainer").on("click", ".delete-comment", function () {
                var commentId = $(this).data("comment-id");
                var postId = @Model.Id;
                $.ajax({
                    url: '/post/' + postId + '/comment/' + commentId,
                    method: 'DELETE',
                    success: function (response) {
                        // Update the comments list with the new rendered HTML
                        $("#commentsList").html(response);
                    },
                    error: function () {
                        alert("Error deleting comment.");
                    }
                });
            });
        });
    </script>
}
